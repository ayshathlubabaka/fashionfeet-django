{% extends 'base.html' %}
{% block content %}

<div class="colorlib-product">
    <div class="container">
        <div class="row row-pb-lg">
            <div class="col-md-12">
                
                    <div class="card text-center">
   
                        <div class="card-body">
                          <h5 class="card-title">My Orders</h5>
                          
                    <table class="table table-hover">
                        <thead>
                          <tr>
                            <th scope="col">Order #</th>
                            <th scope="col">Billing Name</th>
                            <th scope="col">Phone</th>
                            <th scope="col">Order Total</th>
                            <th scope="col">Date</th>
                            <th scope="col">Status</th>
                            <th scope="col">Cancel</th>
                          </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                          <tr>
                            <th scope="row"><a href="{% url 'order_detail' order.order_number  %}">
                              {{order.order_number}}</a></th>
                            <td>{{order.full_name}}</td>
                            <td>{{order.phone}}</td>
                            <td>{{order.order_total}}</td>
                            <td>{{order.created_at}}</td>
                            <td id="status-{{ order.id }}">{{ order.status }}</td>
                            <td>
                              {% if order.status != 'Cancelled' %}
                              <form class="cancel-order-form" data-order-id="{{ order.id }}" data-cancel-url="{% url 'cancel_order' order.id %}">
                                {% csrf_token %}
                                <button type="submit" class="cancel-order-btn" style="background-color: red;">Cancel</button>
                              </form>
                              {% else %}
                               <button style="background-color: rgb(48, 157, 197);"><span class="cancelled-status">Cancelled</span></button>
                              {% endif %}
                            </td>

                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                         
                        </div>
                      </div>
                </div>
                
        
        </div>
        
        
        </div>
    </div>
    <script>

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      // Does this cookie string begin with the name we want?
      if (cookie.substring(0, name.length + 1) === (name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

$(document).ready(function() {
    $(".cancel-order-form").submit(function(event) {
        event.preventDefault(); // Prevent the form from submitting normally
        
        if (confirm('Are you sure you want to cancel this order?')) {
            var form = $(this);
            var orderId = form.data("order-id");
            var cancelUrl = form.data("cancel-url");
            
            $.ajax({
                url: cancelUrl,
                type: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                success: function(data) {
                    if (data.message === "Order cancelled successfully") {
                        var cancelButton = form.find(".cancel-order-btn");
                        cancelButton.text("Cancelled"); // Update the button text
                        cancelButton.prop("disabled", true); // Disable the button
                        cancelButton.css("background-color", "blue");
                        
                        var statusElement = $("#status-" + orderId);
                        statusElement.text("Cancelled"); // Update the status text
                        statusElement.addClass("cancelled-status"); // Apply the "cancelled-status" class
                    }
                },
                error: function(error) {
                    console.error(error);
                }
            });
        }
    });
});
</script>
{% endblock %}